# プロジェクト納品自動化ツール 設計書

## 1. 概要

- 本ツールは、`Microsoft Teams` のローカルドライブに存在するプロジェクト成果物の中から、指定されたファイルを抽出し、納品時に必要な標準フォルダ構造にファイルをコピーする CUI ツールです。

## 2. 目的

- `Teams` から納品物へのファイル抽出・コピー作業の効率化
- 納品物の内容確認（ツリー出力による視覚化）

## 3. 動作環境

- **OS**: Windows 10/11
- **Python**: 3.8 以上
- **開発環境**: VS Code (推奨)
- **必須コマンド**: tree コマンド (Windows 標準コマンド)

## 4. 機能要件

### 4.1. ファイル抽出・コピー機能 (必須)

- **機能概要**: `Microsoft Teams` ローカルドライブの指定されたパスから、指定されたファイル名パターンに合致するファイルを抽出し、設定ファイルで指定された納品用フォルダ構造の適切な位置にコピーします。
- **決定事項**:
  - **抽出対象ファイル名の指定**: `*` を含む部分一致（ワイルドカード）を許容します。例: `*設計書*.docx`
  - **複数ファイル名の指定**: 1 回の実行につき、**1 つのファイル名パターンのみ** を指定できるものとします。複数のファイル種類をコピーしたい場合は、ツールを複数回実行します。
  - **探索範囲**: `Teams` ローカルパスとして指定されたルートディレクトリ配下の**全階層**を探索します。
  - **コピー先判定**: 抽出されたファイル名に基づき、設定ファイルで定義された「成果物フォルダ」マッピングに合致するフォルダ（例: ファイル名に「機能設計書」が含まれていれば「040.設計」フォルダ）にコピーします。
    `**====消すかも===**`
    合致するフォルダが複数ある場合は、最初の合致先にコピーします。合致するフォルダがない場合は、標準出力に警告メッセージを出力し、コピーは行いません。
    `**=============**`
  - **同名ファイル**: コピー先に同名のファイルが存在する場合は、**上書き**します。

### 4.2. 納品フォルダツリー出力機能 (必須)

- **機能概要**: ファイルコピー処理が完了した後、納品先ルートフォルダ配下に作成されたのフォルダのツリー構造を、**Windows の`tree`コマンド**を利用してテキストファイルとして出力します。

* **出力形式**: `tree`コマンドに準拠した形式 (`tree -F`に相当する出力)。
* **出力対象**: コピー処理で生成された `[アイテム名]` フォルダ配下全体。
* **出力先**: コマンドライン引数で指定されたファイルパス。指定がない場合は出力しません。

## 5. 非機能要件

### 5.1. ユーザビリティ

- **インターフェース**: コマンドラインインターフェース (CUI) とします。
- **引数**: コマンドライン引数は設定ファイルのパス、抽出対象のファイル名パターン、およびツリー出力のオプション（出力有無、ファイルパス）とします。
- **メッセージ**: 処理の進捗状況、成功/失敗、エラー内容などを標準出力に分かりやすく表示します。

### 5.2. エラーハンドリング

- **ファイル/フォルダ操作エラー**: ファイルが見つからない、コピーに失敗したなどのエラーが発生した場合は、その旨を標準出力に表示し、**処理を中断せず、可能な限り次のファイル/フォルダの処理へ進みます**。
- **入力値エラー**: コマンドライン引数の不足や不正な値、設定ファイルの読み込み失敗や不正な内容の場合は、エラーメッセージを表示し、ツールを終了します。
- **ツリー出力エラー**: ツリー出力時にファイル書き込みエラーが発生した場合でも、ツールのメイン処理は中断せず、エラーメッセージを標準出力に出力するに留めます。

### 5.3. ロギング

- **標準出力**: 処理の成功/失敗に関わらず、コピーしたファイル名、コピー元パス、コピー先パス、ツリー出力の状況を標準出力に出力します。
- **ログファイル**: 今回はログファイルの出力は行いません。必要になった際に検討します。

### 5.4. 保守性

- **コードコメント**: 新人でも理解しやすいよう、関数や主要な処理ブロックには詳細なコメントを記述します。
- **`README.md`**: ツールの概要、実行方法、コマンドライン引数、設定ファイルの記述方法を Markdown 形式で記述します。

## 6. コマンドライン引数 (CLI) 仕様

ツールは以下の形式で実行するものとします。

```bash
python main.py <config_file_path> <file_pattern> [--tree-output <tree_output_file_path>]
```

- `<config_file_path>` (必須): 設定ファイルのパス。
  - 例: `"config.ini"` または `"./configs/project_a_q3.ini"`
- `<file_pattern>` (必須): 抽出対象のファイル名パターン (ワイルドカード `*` 使用可能)。
  - 例: `"調査検討書_アイテムA.xlsx"`
- `--tree-output <tree_output_file_path>` (オプション):
  - このオプションを指定すると、納品フォルダのツリー構造を `<tree_output_file_path>` に出力します。
  - 例: `--tree-output "delivery_tree.txt"`
  - オプションが指定されない場合、ツリー出力は行いません。

**実行例**:

```bash
# ファイルコピーのみ
python main.py "config.ini" "*調査検討書_アイテムA.xlsx"

# ファイルコピーとツリー出力
python main.py "config.ini" "*調査検討書_アイテムA.xlsx" --tree-output "delivery_tree_PJT_A_Q3.txt"
```

## 7. 内部設計

### 7.1. モジュール構成

```
.
├── main.py               # メイン処理 (引数解析、設定ファイル読み込み、各モジュール呼び出し)
├── file_processor.py     # ファイル抽出・コピー、ツリー出力関連モジュール
└── config_manager.py     # 設定ファイル読み込み・解析モジュール
```

### 7.2. クラス/関数設計

#### `main.py`

- `main()` 関数:
  - コマンドライン引数を解析する（`argparse`モジュールを推奨）。
    - 設定ファイルのパス、ファイルパターン、ツリー出力ファイルパスを解析。
  - 引数チェックを行い、不正な場合はエラーメッセージを表示して終了。
  - `config_manager.load_config` を呼び出し、設定ファイルを読み込み、解析する。
  - 読み込んだ設定情報とファイルパターンを `file_processor.process_files` に渡し、ファイルの抽出とコピーを実行する。
  - もしツリー出力ファイルパスが指定されていれば、`file_processor.generate_tree_output` を呼び出し、ツリー出力を行う。
  - 処理結果を標準出力に表示する。

#### `config_manager.py`

- **機能概要**: INI 形式の設定ファイルを読み込み、必要な設定情報を辞書形式で返すモジュール。
- **`load_config(config_file_path)` 関数**:
  - **引数**: `config_file_path` (str)
  - **戻り値**: 設定情報を含む辞書 (dict)
  - **例外**: ファイルが見つからない、読み込みエラー、必須項目不足などが発生した場合は例外を発生させる。
  - **処理内容**:
    - `configparser` モジュールを使用して指定された INI ファイルを読み込む。
    - 以下のセクションとキーを必須項目として読み込む:
      - `[General]`
        - `teams_root_path` (str): `Microsoft Teams` ローカルドライブのルートパス
        - `delivery_root_path` (str): 納品物を配置するルートパス
        - `project_name` (str): プロジェクト名
        - `item_name` (str): アイテム名（フェーズ名など）
        - `delivery_year` (int): 納品フォルダに使う年度 (例: 2024)
        - `delivery_quarter` (str): 納品フォルダに使う四半期 (例: Q3)
      - `[Mappings]`
        - `[ファイル名キーワード]=[コピー先フォルダ相対パス]` の形式でマッピングを読み込む。
        - 例: `要求仕様書 = 要件定義/要求仕様書`
    - 読み込んだ設定情報を辞書として返す。

#### `file_processor.py`

- `process_files(config, file_pattern)` 関数:

  - **引数**: `config` (dict), `file_pattern` (str)
  - **戻り値**: 生成された納品先ルートパス (str)。ツリー出力時に使用。
  - **処理内容**:
    - `config` から必要な設定情報を取得。
    - **納品先フォルダの構築**:
      - `delivery_root_path` 配下に `[delivery_year]\[delivery_quarter]\[project_name]\[item_name]` までのパスを構築。これを `delivery_base_path` とする。
      - `os.makedirs(delivery_base_path, exist_ok=True)` で主要フォルダを生成。
      - `Mappings` に基づいて、`delivery_base_path` 配下の各成果物フォルダ（例: `要件定義/要求仕様書` など）も `os.makedirs` で事前に生成する。
    - `os.walk(config['teams_root_path'])` を使用して、`teams_root_path` 配下のファイルを探索。
    - 合致したファイルを `Mappings` に基づいて `delivery_base_path` 配下の適切なフォルダにコピー。
    - 処理結果を標準出力に表示。
    - 最終的に `delivery_base_path` を返す。

- `generate_tree_output(target_path, output_file_path)` 関数:
  - **引数**: `target_path` (str), `output_file_path` (str)
  - **戻り値**: なし
  - **処理内容**:
    - `subprocess`モジュールを使用して、Windows の`tree`コマンドを実行する。
    - コマンドは `tree /F "<target_path>"` の形式とする (`/F` はファイル名も表示するオプション)。
    - `subprocess.run()` の `capture_output=True` と `text=True` を使用してコマンドの出力を取得し、それを `output_file_path` に書き出す。
    - コマンド実行エラーやファイル書き込みエラーが発生した場合は、標準出力にエラーメッセージを出力するが、処理は継続する。
    - **注意**: この機能は Windows 環境でのみ動作します。

## 8. 設定ファイル (INI 形式) 例

`config.ini`

```ini
[General]
teams_root_path = T:\Teams\プロジェクトA
delivery_root_path = D:\納品物
project_name = PJT_A
item_name = Phase1_Design
delivery_year = 2024
delivery_quarter = Q3

[Mappings]
# ファイル名に含まれるキーワード = 納品先フォルダパス (delivery_base_pathからの相対パス)
# 例: ファイル名に「調査検討書」が含まれる場合、納品先は delivery_base_path/[案件名]/030.調査 となる
調査検討書 = `[案件名]`/030.調査
要件整理書 = `[案件名]`/030.調査
機能設計書 = `[案件名]`/040.設計
*.py = `[案件名]`/050.製造
単体試験仕様書 = `[案件名]`/060.UD作成
単体試験成績書 = `[案件名]`/070.UD消化
結合試験仕様書 = `[案件名]`/080.SD作成
結合試験成績書 = `[案件名]`/090.SD消化
試験結果報告書 = `[案件名]`/090.SD消化
```

## 9. テスト方針

### 9.1. 手動テスト

- **仮想フォルダの準備**:
  - `Teams` のローカルパスを模したダミーのフォルダ構造とダミーファイルをいくつか作成します。
  - 納品先パスとして、空のフォルダを作成します。
- **設定ファイルの準備**: 上記の INI 形式のサンプルに従い、`config.ini` を作成します。
- **テストシナリオ**:
  - **正常系**:
    - 全ての引数と設定ファイルを正しく指定し、期待通りにフォルダが生成され、ファイルがコピーされることを確認。
    - `--tree-output` オプションを指定した場合に、指定されたパスにツリーファイルが生成され、内容が`tree -F`コマンドの出力と一致することを確認。
  - **異常系**:
    - コマンドライン引数不足、不正な引数を指定した場合に、適切なエラーメッセージが表示されることを確認。
    - `config.ini` が存在しない、または形式が不正な場合に、適切なエラーメッセージが表示されることを確認。
    - 設定ファイル内の`teams_root_path`が存在しない場合に、エラーメッセージが表示されることを確認。
    - 抽出対象ファイルが見つからない場合に、警告メッセージが表示されることを確認（コピーは行われない）。
    - コピー先に同名ファイルが存在する場合に、正しく上書きされることを確認。
    - ファイル名が`Mappings`に合致しない場合に、コピーされないことを確認。
    - ツリー出力先のファイルパスが無効な場合（書き込み権限がないなど）に、エラーメッセージが表示されるが、メイン処理は継続することを確認。

### 9.2. (将来的な検討) 単体テスト

- Python の `unittest` モジュールなどを利用し、各関数の独立したテストコードを作成します。
- 特に `config_manager.load_config` (設定ファイルの読み込みと解析)、`file_processor.process_files` (ファイルパス構築、コピーロジック) を対象とします。
- `generate_tree_output` は`subprocess`呼び出しがメインとなるため、直接的な単体テストは難しい場合があります。結合テストや E2E テストで検証を補うことを検討します。
- ファイル操作を伴うテストは、`tempfile` モジュールなどを利用して一時ファイル/ディレクトリを作成し、テスト後に削除するようにします。

## 10. 今後の拡張 (今回は実装しない)

- ログファイルへの出力機能
- 複数のファイルパターンをコマンドライン引数または設定ファイルで指定への対応
- ファイルのタイトルチェック、日付チェック、捺印判定機能 (画像認識)
